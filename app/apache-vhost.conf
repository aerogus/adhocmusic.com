<VirtualHost *:80>

ServerName adhocmusic.com
ServerAlias www.adhocmusic.com static.adhocmusic.com
ServerAlias adhocmusic.localhost www.adhocmusic.localhost static.adhocmusic.localhost
DocumentRoot /var/www/adhocmusic.com/public

<Directory /var/www/adhocmusic.com/public>

Options Indexes FollowSymLinks MultiViews
AllowOverride None
Require all granted

# .htaccess adhocmusic.com

# Gestion multi environnement
SetEnvIf Host ^adhocmusic.com$                ADHOC_ENV_PROD
SetEnvIf Host ^www\.adhocmusic\.com$          ADHOC_ENV_PROD
SetEnvIf Host ^static\.adhocmusic\.com$       ADHOC_ENV_PROD
SetEnvIf Host ^adhocmusic\.localhost$         ADHOC_ENV_DEV
SetEnvIf Host ^www\.adhocmusic\.localhost$    ADHOC_ENV_DEV
SetEnvIf Host ^static\.adhocmusic\.localhost$ ADHOC_ENV_DEV

RewriteEngine on

# ajout des www si omis sur la prod - https
RewriteCond %{ENV:ADHOC_ENV_PROD} !^$
RewriteCond %{HTTP_HOST} !^www.adhocmusic.com$ [NC]
RewriteCond %{HTTPS} on [OR]
RewriteCond %{HTTP:X-Forwarded-Proto} https
RewriteRule ^(.*)$ https://www.adhocmusic.com/$1 [R=301,L]

# ajout des www si omis sur la prod - http
RewriteCond %{ENV:ADHOC_ENV_PROD} !^$
RewriteCond %{HTTP_HOST} !^www.adhocmusic.com$ [NC]
RewriteCond %{HTTPS} !on
RewriteCond %{HTTP:X-Forwarded-Proto} !https
RewriteRule ^(.*)$ http://www.adhocmusic.com/$1 [R=301,L]

# ajout des www si omis sur le dev - https
RewriteCond %{ENV:ADHOC_ENV_DEV} !^$
RewriteCond %{HTTP_HOST} !^www.adhocmusic.localhost$ [NC]
RewriteCond %{HTTPS} on [OR]
RewriteCond %{HTTP:X-Forwarded-Proto} https
RewriteRule ^(.*)$ https://www.adhocmusic.localhost/$1 [R=301,L]

# ajout des www si omis sur le dev - http
RewriteCond %{ENV:ADHOC_ENV_DEV} !^$
RewriteCond %{HTTP_HOST} !^www.adhocmusic.localhost$ [NC]
RewriteCond %{HTTPS} !on
RewriteCond %{HTTP:X-Forwarded-Proto} !https
RewriteRule ^(.*)$ http://www.adhocmusic.localhost/$1 [R=301,L]

# versionning par nom de fichiers des js/css,images et sons, ex: image.1234.jpg -> image.jpg
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^(.+)\.([0-9]+)\.(min\.)?(js|css|jpg|png|gif|mp3|ogg)$ $1.$3$4

RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^(.+)show/([0-9]+)$ /$1$2 [R=301,L]

# encodage caractères
AddDefaultCharset utf-8
AddCharset utf-8 .html .xhtml .xml .rss .json .jsonp .css .js .svg

# gestion content-type
AddType image/svg+xml .svg
AddType image/x-icon .ico
AddType application/json .json
AddType application/javascript .js
AddType video/mp4 .mp4
AddType video/ogg .ogv
AddType video/webm .webm
AddType application/vnd.ms-fontobject .eot
AddType application/x-font-ttf .ttf
AddType application/font-woff .woff
AddType application/font-woff2 .woff2
AddType application/x-ns-proxy-autoconfig .dat

# gestion expirations
<ifModule mod_expires.c>
# data
ExpiresByType text/html        "access plus 0 seconds"
ExpiresByType application/xml  "access plus 0 seconds"
ExpiresByType application/json "access plus 0 seconds"

# images
ExpiresByType image/gif     "access plus 30 days"
ExpiresByType image/png     "access plus 30 days"
ExpiresByType image/jpg     "access plus 30 days"
ExpiresByType image/jpeg    "access plus 30 days"
ExpiresByType image/svg+xml "access plus 30 days"
ExpiresByType image/x-icon  "access plus 30 days"

# css and javascript
ExpiresByType text/css                 "access plus 30 days"
ExpiresByType text/javascript          "access plus 30 days"
ExpiresByType application/x-javascript "access plus 30 days"
ExpiresByType application/javascript   "access plus 30 days"

# webfonts (ttf, woff, woff2)
ExpiresByType application/x-font-ttf "access plus 30 days"
ExpiresByType application/font-woff  "access plus 30 days"
ExpiresByType application/font-woff2 "access plus 30 days"
</ifModule>

# désactivation ETag
Header unset ETag
FileETag None

# compression gzip des contenus texte
<IfModule mod_deflate.c>
AddOutputFilterByType DEFLATE text/html text/xml text/css text/plain text/javascript application/javascript application/x-javascript application/json image/svg+xml
</IfModule>

DirectoryIndex index.php

Options +FollowSymlinks
Options -Indexes
Options -MultiViews

# route unique
FallbackResource /index.php

ErrorDocument 400 "400"
ErrorDocument 403 "403"
ErrorDocument 404 "404"
ErrorDocument 500 "500"

</Directory>

ErrorLog ${APACHE_LOG_DIR}/adhocmusic.com.error.log
CustomLog ${APACHE_LOG_DIR}/adhocmusic.com.access.log combined

</VirtualHost>

<VirtualHost *:443>

ServerName adhocmusic.com
ServerAlias www.adhocmusic.com static.adhocmusic.com
DocumentRoot /var/www/adhocmusic.com/public

<Directory /var/www/adhocmusic.com/public>

Options Indexes FollowSymLinks MultiViews
AllowOverride None
Require all granted

# .htaccess adhocmusic.com

# Gestion multi environnement
SetEnvIf Host ^adhocmusic.com$                ADHOC_ENV_PROD
SetEnvIf Host ^www\.adhocmusic\.com$          ADHOC_ENV_PROD
SetEnvIf Host ^static\.adhocmusic\.com$       ADHOC_ENV_PROD
SetEnvIf Host ^adhocmusic\.localhost$         ADHOC_ENV_DEV
SetEnvIf Host ^www\.adhocmusic\.localhost$    ADHOC_ENV_DEV
SetEnvIf Host ^static\.adhocmusic\.localhost$ ADHOC_ENV_DEV

RewriteEngine on

# ajout des www si omis sur la prod - https
RewriteCond %{ENV:ADHOC_ENV_PROD} !^$
RewriteCond %{HTTP_HOST} !^www.adhocmusic.com$ [NC]
RewriteCond %{HTTPS} on [OR]
RewriteCond %{HTTP:X-Forwarded-Proto} https
RewriteRule ^(.*)$ https://www.adhocmusic.com/$1 [R=301,L]

# ajout des www si omis sur la prod - http
RewriteCond %{ENV:ADHOC_ENV_PROD} !^$
RewriteCond %{HTTP_HOST} !^www.adhocmusic.com$ [NC]
RewriteCond %{HTTPS} !on
RewriteCond %{HTTP:X-Forwarded-Proto} !https
RewriteRule ^(.*)$ http://www.adhocmusic.com/$1 [R=301,L]

# ajout des www si omis sur le dev - https
RewriteCond %{ENV:ADHOC_ENV_DEV} !^$
RewriteCond %{HTTP_HOST} !^www.adhocmusic.localhost$ [NC]
RewriteCond %{HTTPS} on [OR]
RewriteCond %{HTTP:X-Forwarded-Proto} https
RewriteRule ^(.*)$ https://www.adhocmusic.localhost/$1 [R=301,L]

# ajout des www si omis sur le dev - http
RewriteCond %{ENV:ADHOC_ENV_DEV} !^$
RewriteCond %{HTTP_HOST} !^www.adhocmusic.localhost$ [NC]
RewriteCond %{HTTPS} !on
RewriteCond %{HTTP:X-Forwarded-Proto} !https
RewriteRule ^(.*)$ http://www.adhocmusic.localhost/$1 [R=301,L]

# versionning par nom de fichiers des js/css,images et sons, ex: image.1234.jpg -> image.jpg
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^(.+)\.([0-9]+)\.(min\.)?(js|css|jpg|png|gif|mp3|ogg)$ $1.$3$4

RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^(.+)show/([0-9]+)$ /$1$2 [R=301,L]

# encodage caractères
AddDefaultCharset utf-8
AddCharset utf-8 .html .xhtml .xml .rss .json .jsonp .css .js .svg

# gestion content-type
AddType image/svg+xml .svg
AddType image/x-icon .ico
AddType application/json .json
AddType application/javascript .js
AddType video/mp4 .mp4
AddType video/ogg .ogv
AddType video/webm .webm
AddType application/vnd.ms-fontobject .eot
AddType application/x-font-ttf .ttf
AddType application/font-woff .woff
AddType application/font-woff2 .woff2
AddType application/x-ns-proxy-autoconfig .dat

# gestion expirations
<ifModule mod_expires.c>
# data
ExpiresByType text/html        "access plus 0 seconds"
ExpiresByType application/xml  "access plus 0 seconds"
ExpiresByType application/json "access plus 0 seconds"

# images
ExpiresByType image/gif     "access plus 30 days"
ExpiresByType image/png     "access plus 30 days"
ExpiresByType image/jpg     "access plus 30 days"
ExpiresByType image/jpeg    "access plus 30 days"
ExpiresByType image/svg+xml "access plus 30 days"
ExpiresByType image/x-icon  "access plus 30 days"

# css and javascript
ExpiresByType text/css                 "access plus 30 days"
ExpiresByType text/javascript          "access plus 30 days"
ExpiresByType application/x-javascript "access plus 30 days"
ExpiresByType application/javascript   "access plus 30 days"

# webfonts (ttf, woff, woff2)
ExpiresByType application/x-font-ttf "access plus 30 days"
ExpiresByType application/font-woff  "access plus 30 days"
ExpiresByType application/font-woff2 "access plus 30 days"
</ifModule>

# désactivation ETag
Header unset ETag
FileETag None

# compression gzip des contenus texte
<IfModule mod_deflate.c>
AddOutputFilterByType DEFLATE text/html text/xml text/css text/plain text/javascript application/javascript application/x-javascript application/json image/svg+xml
</IfModule>

DirectoryIndex index.php

Options +FollowSymlinks
Options -Indexes
Options -MultiViews

# route unique
FallbackResource /index.php

ErrorDocument 400 "400"
ErrorDocument 403 "403"
ErrorDocument 404 "404"
ErrorDocument 500 "500"

</Directory>

ErrorLog ${APACHE_LOG_DIR}/adhocmusic.com.ssl.error.log
CustomLog ${APACHE_LOG_DIR}/adhocmusic.com.ssl.access.log combined
SSLEngine on
SSLCertificateFile    /etc/apache2/ssl/adhocmusic.com.crt
SSLCertificateKeyFile /etc/apache2/ssl/adhocmusic.com.key
SSLCACertificateFile  /etc/apache2/ssl/adhocmusic.com.inter.crt

</VirtualHost>
